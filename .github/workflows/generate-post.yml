name: Generate Blog Post

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Blog post topic (leave empty to pick from topics.yml)'
        required: false
        type: string
      additional_context:
        description: 'Extra context or instructions for the post'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Resolve topic
        id: topic
        env:
          INPUT_TOPIC: ${{ github.event.inputs.topic }}
          INPUT_CONTEXT: ${{ github.event.inputs.additional_context }}
        run: |
          python3 << 'PYEOF'
          import os, yaml

          manual_topic = os.environ.get("INPUT_TOPIC", "")
          extra_context = os.environ.get("INPUT_CONTEXT", "")
          output = os.environ["GITHUB_OUTPUT"]

          if manual_topic:
              title = manual_topic
              description = extra_context or manual_topic
              tags = "blog"
              category = "general"
              from_queue = "false"
              queue_index = "-1"
          else:
              with open("topics.yml") as f:
                  data = yaml.safe_load(f)

              title = None
              for i, t in enumerate(data["topics"]):
                  if t["status"] == "pending":
                      title = t["title"]
                      description = t.get("description", "").strip()
                      tags = t.get("tags", "blog")
                      category = t.get("category", "general")
                      from_queue = "true"
                      queue_index = str(i)
                      break

              if not title:
                  print("::error::No pending topics in topics.yml")
                  raise SystemExit(1)

          with open(output, "a") as f:
              f.write(f"title={title}\n")
              # Use delimiter syntax for multiline description
              f.write(f"description<<DESCEOF\n")
              f.write(f"{description}\n")
              f.write(f"DESCEOF\n")
              f.write(f"tags={tags}\n")
              f.write(f"category={category}\n")
              f.write(f"from_queue={from_queue}\n")
              f.write(f"queue_index={queue_index}\n")

          print(f"Topic: {title}")
          PYEOF

      - name: Generate post with Claude
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TOPIC_TITLE: ${{ steps.topic.outputs.title }}
          TOPIC_DESCRIPTION: ${{ steps.topic.outputs.description }}
          TOPIC_TAGS: ${{ steps.topic.outputs.tags }}
          TOPIC_CATEGORY: ${{ steps.topic.outputs.category }}
          EXTRA_CONTEXT: ${{ github.event.inputs.additional_context }}
        run: |
          python3 << 'PYEOF'
          import json, os, urllib.request, datetime

          today = datetime.date.today().isoformat()

          with open(".claude/blog-prompt.md") as f:
              prompt_template = f.read()

          title = os.environ["TOPIC_TITLE"]
          description = os.environ["TOPIC_DESCRIPTION"]
          tags = os.environ["TOPIC_TAGS"]
          category = os.environ["TOPIC_CATEGORY"]
          extra = os.environ.get("EXTRA_CONTEXT", "")

          full_prompt = f"""{prompt_template}

          ---

          Write a blog post with the following details:

          **Topic:** {title}
          **Description:** {description}
          **Tags:** {tags}
          **Category:** {category}
          **Date:** {today}

          {f'Additional context: {extra}' if extra else ''}

          Return ONLY the complete markdown file content, starting with the YAML front matter (---) and ending with the post content. No code fences, no explanation."""

          api_key = os.environ["ANTHROPIC_API_KEY"]
          if not api_key:
              print("::error::ANTHROPIC_API_KEY secret is not set")
              raise SystemExit(1)

          request_body = json.dumps({
              "model": "claude-sonnet-4-5-20250929",
              "max_tokens": 4096,
              "messages": [{"role": "user", "content": full_prompt}]
          }).encode()

          req = urllib.request.Request(
              "https://api.anthropic.com/v1/messages",
              data=request_body,
              headers={
                  "Content-Type": "application/json",
                  "x-api-key": api_key,
                  "anthropic-version": "2023-06-01"
              }
          )

          try:
              with urllib.request.urlopen(req) as resp:
                  data = json.loads(resp.read())
          except urllib.error.HTTPError as e:
              body = e.read().decode()
              print(f"::error::Claude API error ({e.code}): {body}")
              raise SystemExit(1)

          post_content = data["content"][0]["text"]

          # Generate slug from title
          slug = title.lower()
          for ch in " '\"?!,.:;()[]{}#@&+=/\\":
              slug = slug.replace(ch, "-")
          while "--" in slug:
              slug = slug.replace("--", "-")
          slug = slug.strip("-")
          filename = f"{today}-{slug}.markdown"

          post_path = f"_posts/{filename}"
          with open(post_path, "w") as f:
              f.write(post_content)

          print(f"Generated: {post_path}")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"filename={filename}\n")
              f.write(f"slug={slug}\n")
              f.write(f"date={today}\n")
          PYEOF

      - name: Update topic queue
        if: steps.topic.outputs.from_queue == 'true'
        env:
          QUEUE_INDEX: ${{ steps.topic.outputs.queue_index }}
        run: |
          python3 << 'PYEOF'
          import os, yaml

          idx = int(os.environ["QUEUE_INDEX"])

          with open("topics.yml") as f:
              data = yaml.safe_load(f)

          data["topics"][idx]["status"] = "published"

          with open("topics.yml", "w") as f:
              yaml.dump(data, f, default_flow_style=False, sort_keys=False, allow_unicode=True)

          print(f"Marked topic {idx} as published")
          PYEOF

      - name: Create branch and PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          POST_SLUG: ${{ steps.generate.outputs.slug }}
          POST_FILENAME: ${{ steps.generate.outputs.filename }}
          POST_DATE: ${{ steps.generate.outputs.date }}
          TOPIC_TITLE: ${{ steps.topic.outputs.title }}
          FROM_QUEUE: ${{ steps.topic.outputs.from_queue }}
        run: |
          BRANCH="blog/post-${POST_SLUG}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add "_posts/${POST_FILENAME}"
          if [ "$FROM_QUEUE" = "true" ]; then
            git add topics.yml
          fi
          git commit -m "Add blog post: ${TOPIC_TITLE}"
          git push -u origin "$BRANCH"

          gh pr create \
            --title "New Post: ${TOPIC_TITLE}" \
            --body "## New Blog Post

          **Topic:** ${TOPIC_TITLE}
          **Generated:** ${POST_DATE}
          **File:** \`_posts/${POST_FILENAME}\`

          ### Review Checklist
          - [ ] Read through the post for accuracy
          - [ ] Check tone and voice
          - [ ] Verify code examples (if any)
          - [ ] Check tags and categories

          > Generated by Claude via GitHub Actions. Review, edit if needed, and merge to publish." \
            --base main \
            --head "$BRANCH"
